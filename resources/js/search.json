[[{"l":"Getting started","p":["Welcome to the Netlify Skew Protection package documentation, a library to seamlessly add a Skew Protection feature to your Netlify site. On this page, you'll discover how this package can help avoir version skew and learn how to set it up."]},{"l":"Problem","p":["When deploying a new version of a static site, users who are still browsing the previous version may encounter 404 errors for static assets like JavaScript or CSS files. This happens because the new deployment instantly replaces the old one at the entry point, but users' files still references asset filenames that were unique to the previous build. As a result, when a user navigates to a page during this transition, the browser requests files may no longer exist, leading to broken pages and degraded user experience.","At Workleap, version skew most commonly occurs with lazy-loaded routes."]},{"l":"Solution","p":["Skew Protection addresses this by maintaining a consistent experience for each user session. It does so by assigning a cookie when a user first fetch the entry point, tying that session to a specific deployment id. All subsequent asset requests are routed to that specific deploy URL (e.g., https://deploy-id--your-site.netlify.app), ensuring that users always receive the correct asset versions associated with the entry point they were served. This prevents asset mismatches and eliminates 404 errors caused by mid-session deploy transitions, resulting in smoother, safer releases."]},{"l":"Set up Skew Protection","p":["Let's create an edge function, then register the edge function, build the edge function, and finally configure the Netlify site."]},{"l":"Create the edge function","p":["First, open a terminal at the root of the web application project that will include the Netlify edge function and install the following packages:","While you can use any package manager to develop an application with Squide, it is highly recommended that you use PNPM as the guides has been developed and tested with PNPM.","Then, create the edge function under a netlify folder and name the file skew-protection.ts(yes the file will be in TypeScript):","Finally, open the skew-protection.ts file and paste the following content:","The previous code ☝️ assumes that the application entry point is a index.html file. If the application entry point is different, make sure to replace /index.html for the actual entry point of the application."]},{"l":"Register the edge function","p":["Now, let's register the edge function with Netlify.","If the application doesn't have a netlify.toml file yet, create a new one at the root of the project:","Open the netlify.toml file and register the edge-function by pasting the following content:"]},{"l":"Build the edge function","p":["Finally, depending of how the application is deployed to a Netlify site, additional steps might be required."]},{"l":"From Netlify CLI","p":["If the application is deployed to it's Netlify site using the Netlify CLI, your good to go, no additional steps are required."]},{"l":"From Netlify CD","p":["If the application is deployed to it's Netlify site with the Netlify CD, you might hit a limitation with the imports of an NPM package in a Netlify edge function. The solution is to either build the edge function manually using Rslib or importing the NPM package through the intermediate of esm.sh."]},{"l":"Rslib","p":["First, open a terminal at the root of the web application project that will include the Netlify edge function and install the following packages:","While you can use any package manager to develop an application with Squide, it is highly recommended that you use PNPM as the guides has been developed and tested with PNPM.","Then, create a rslib.edge-functions.ts file at the root of the project:","Open the rslib.edge-functions.ts file and paste the following content:","Next, open the netlify.toml created earlier and update the build.edge_functions property to match the dist path of the rslib configuration file:","Finally, update the build script of the project to build the edge functions as well:"]},{"i":"esmsh","l":"esm.sh","p":["Importing the NPM package with esm.sh is more straightforward but involves an additional third party. To import the @workleap/netlify-skew-protection package using esm.sh, import the package of the package for the following code:","Since the package is downloaded from a third party server rather than being imported from a node_modules folder, the @workleap/netlify-skew-protection dependency can be removed from the project package.json.","The previous example ☝️ always import the latest version of the package. esm.sh also support specifying a specific version of the package if needed."]},{"l":"Configure the Netlify site","p":["Now, generate a new secret using the OpenSSL CLI:","Save the generated value and to go the application Netlify site. Add a new environment variabled named SKEW_PROTECTION_SECRET and set the generated secret as the value."]},{"i":"try-it","l":"Try it \uD83D\uDE80","p":["To test your new set up, follow these steps:","Open a browser with the Dev Tools opened to the network tab and navigate to your application.","Search for the entry point file of the application and take a look at the response headers.","The Set-Cookie header should include an nf_sp cookie (or wathever name you choose for the Skew Protection cookie)"]},{"l":"Troubleshoot issues","p":["If the cookie is not set, troubleshoot the issue using Netlify edge functions logs.","If the logs mentions that the edge function is not installed properly, this is probably because the site doesn't include an SKEW_PROTECTION_SECRET environment variable.","If the requests to previous asset files are not re-routed, set the debug option, deploy the edge function again and troubleshoot the issue using the edge functions logs."]}],[{"l":"About","p":["To ask a question or propose an idea, feel free to start a new discussion on Github. If you found a bug, please open an issue on Github."]},{"l":"Contributing","p":["Have a look at the contributor's documentation."]},{"l":"License","p":["See the LICENSE on Github."]}],[{"l":"Available options"},{"l":"secretEnvironmentVariableName","p":["TBD"]},{"l":"basicAuthPasswordEnvironmentVariableName","p":["TBD"]},{"l":"cookieName","p":["TBD"]},{"l":"cookieMaxAgeInMs","p":["TBD"]},{"l":"debug","p":["TBD"]}]]